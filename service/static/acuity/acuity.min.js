var es={specialChars:["\\","+","-","=","&&","||",">","<","!","(",")","{","}","[","]","^",'"',"~","*","?",":","/"],specialCharsSubSet:["\\","+","-","=","&&","||",">","<","!","(",")","{","}","[","]","^","~","?",":","/"],characterPairs:['"'],distanceUnits:["km","mi","miles","in","inch","yd","yards","kilometers","mm","millimeters","cm","centimeters","m","meters"],aggregationFactory:function(type,params){var constructors={terms:es.newTermsAggregation,range:es.newRangeAggregation,geo_distance:es.newGeoDistanceAggregation,date_histogram:es.newDateHistogramAggregation,stats:es.StatsAggregation,cardinality:es.CardinalityAggregation};if(constructors[type]){return constructors[type](params)}},filterFactory:function(type,params){var constructors={query_string:es.newQueryString,term:es.newTermFilter,terms:es.newTermsFilter,range:es.newRangeFilter,geo_distance_range:es.newGeoDistanceRangeFilter};if(constructors[type]){return constructors[type](params)}},newQuery:function(params){if(!params){params={}}return new es.Query(params)},Query:function(params){this.filtered=params.filtered||true;this.size=params.size!==undefined?params.size:false;this.from=params.from||false;this.fields=params.fields||[];this.aggs=params.aggs||[];this.must=params.must||[];this.queryString=false;this.sort=[];this.source=params.source||false;this.should=params.should||[];this.mustNot=params.mustNot||[];this.partialFields=params.partialFields||false;this.scriptFields=params.scriptFields||false;this.minimumShouldMatch=params.minimumShouldMatch||false;this.partialFields=params.partialFields||false;this.scriptFields=params.scriptFields||false;this.facets=params.facets||[];this.getSize=function(){if(this.size!==undefined&&this.size!==false){return this.size}return 10};this.getFrom=function(){if(this.from){return this.from}return 0};this.addField=function(field){if($.inArray(field,this.fields)===-1){this.fields.push(field)}};this.setQueryString=function(params){var qs=params;if(!(params instanceof es.QueryString)){if($.isPlainObject(params)){qs=es.newQueryString(params)}else{qs=es.newQueryString({queryString:params})}}this.queryString=qs};this.getQueryString=function(){return this.queryString};this.removeQueryString=function(){this.queryString=false};this.setSortBy=function(params){this.sort=[];var sorts=params;if(!$.isArray(params)){sorts=[params]}for(var i=0;i<sorts.length;i++){this.addSortBy(sorts[i])}};this.addSortBy=function(params){var sort=params;if(!(params instanceof es.Sort)){sort=es.newSort(params)}for(var i=0;i<this.sort.length;i++){var so=this.sort[i];if(so.field===sort.field){return}}this.sort.push(sort)};this.prependSortBy=function(params){var sort=params;if(!(params instanceof es.Sort)){sort=es.newSort(params)}this.removeSortBy(sort);this.sort.unshift(sort)};this.removeSortBy=function(params){var sort=params;if(!(params instanceof es.Sort)){sort=es.newSort(params)}var removes=[];for(var i=0;i<this.sort.length;i++){var so=this.sort[i];if(so.field===sort.field){removes.push(i)}}removes=removes.sort().reverse();for(var i=0;i<removes.length;i++){this.sort.splice(removes[i],1)}};this.getSortBy=function(){return this.sort};this.setSource=function(include,exclude){};this.addFacet=function(){};this.removeFacet=function(){};this.clearFacets=function(){};this.getAggregation=function(params){var name=params.name;for(var i=0;i<this.aggs.length;i++){var a=this.aggs[i];if(a.name===name){return a}}};this.addAggregation=function(agg,overwrite){if(overwrite){this.removeAggregation(agg.name)}else{for(var i=0;i<this.aggs.length;i++){if(this.aggs[i].name===agg.name){return}}}this.aggs.push(agg)};this.removeAggregation=function(name){var removes=[];for(var i=0;i<this.aggs.length;i++){if(this.aggs[i].name===name){removes.push(i)}}removes=removes.sort().reverse();for(var i=0;i<removes.length;i++){this.aggs.splice(removes[i],1)}};this.clearAggregations=function(){this.aggs=[]};this.listAggregations=function(){return this.aggs};this.addMust=function(filter){var existing=this.listMust(filter);if(existing.length===0){this.must.push(filter)}};this.listMust=function(template){return this.listFilters({boolType:"must",template:template})};this.removeMust=function(template){var removes=[];for(var i=0;i<this.must.length;i++){var m=this.must[i];if(m.matches(template)){removes.push(i)}}removes=removes.sort().reverse();for(var i=0;i<removes.length;i++){this.must.splice(removes[i],1)}return removes.length};this.clearMust=function(){};this.addShould=function(){};this.listShould=function(){};this.removeShould=function(){};this.clearShould=function(){};this.addMustNot=function(){};this.listMustNot=function(){};this.removeMustNot=function(){};this.removeMustNot=function(){};this.hasFilters=function(){return this.must.length>0||this.should.length>0||this.mustNot.length>0};this.listFilters=function(params){var boolType=params.boolType||"must";var template=params.template||false;var bool=[];if(boolType==="must"){bool=this.must}else if(boolType==="should"){bool=this.should}else if(boolType==="must_not"){bool=this.mustNot}if(!template){return bool}var l=[];for(var i=0;i<bool.length;i++){var m=bool[i];if(m.matches(template)){l.push(m)}}return l};this.merge=function(source){this.filtered=source.filtered;if(source.size){this.size=source.size}if(source.from){this.from=source.from}if(source.fields&&source.fields.length>0){for(var i=0;i<source.fields.length;i++){this.addField(source.fields[i])}}var aggs=source.listAggregations();for(var i=0;i<aggs.length;i++){this.addAggregation(aggs[i],true)}var must=source.listMust();for(var i=0;i<must.length;i++){this.addMust(must[i])}if(source.getQueryString()){this.setQueryString(source.getQueryString())}var sorts=source.getSortBy();if(sorts&&sorts.length>0){sorts.reverse();for(var i=0;i<sorts.length;i++){this.prependSortBy(sorts[i])}}};this.objectify=function(params){if(!params){params={}}var include_query_string=params.include_query_string===undefined?true:params.include_query_string;var include_filters=params.include_filters===undefined?true:params.include_filters;var include_paging=params.include_paging===undefined?true:params.include_paging;var include_sort=params.include_sort===undefined?true:params.include_sort;var include_fields=params.include_fields===undefined?true:params.include_fields;var include_aggregations=params.include_aggregations===undefined?true:params.include_aggregations;var include_facets=params.include_facets===undefined?true:params.include_facets;var q={};var query_part={};var bool={};if(this.queryString&&include_query_string){$.extend(query_part,this.queryString.objectify())}if(include_filters){if(this.must.length>0){var musts=[];for(var i=0;i<this.must.length;i++){var m=this.must[i];musts.push(m.objectify())}bool["must"]=musts}}if(this.filtered&&this.hasFilters()){if(Object.keys(query_part).length==0){query_part["match_all"]={}}q["query"]={filtered:{filter:{bool:bool},query:query_part}}}else{if(this.hasFilters()){query_part["bool"]=bool}if(Object.keys(query_part).length==0){query_part["match_all"]={}}q["query"]=query_part}if(include_paging){if(this.size!==undefined&&this.size!==false){q["size"]=this.size}if(this.from){q["from"]=this.from}}if(this.sort.length>0&&include_sort){q["sort"]=[];for(var i=0;i<this.sort.length;i++){q.sort.push(this.sort[i].objectify())}}if(this.fields.length>0&&include_fields){q["fields"]=this.fields}if(this.aggs.length>0&&include_aggregations){q["aggs"]={};for(var i=0;i<this.aggs.length;i++){var agg=this.aggs[i];$.extend(q.aggs,agg.objectify())}}return q};es.Query.prototype.toString=function queryToString(){return JSON.stringify(this.objectify())};this.parse=function(obj){function parseBool(bool,target){if(bool.must){for(var i=0;i<bool.must.length;i++){var type=Object.keys(bool.must[i])[0];var fil=es.filterFactory(type,{raw:bool.must[i]});if(fil){target.addMust(fil)}}}}function parseQuery(q,target){var keys=Object.keys(q);for(var i=0;i<keys.length;i++){var type=keys[i];var impl=es.filterFactory(type,{raw:q[type]});if(impl){if(type==="query_string"){target.setQueryString(impl)}}}}if(obj.query){if(obj.query.filtered){this.filtered=true;var bool=obj.query.filtered.filter.bool;if(bool){parseBool(bool,this)}var q=obj.query.filtered.query;parseQuery(q,this)}else{var q=obj.query;parseQuery(q,this)}}if(obj.size){this.size=obj.size}if(obj.from){this.from=obj.from}if(obj.fields){this.fields=obj.fields}if(obj.sort){for(var i=0;i<obj.sort.length;i++){var so=obj.sort[i];this.addSortBy(es.newSort({raw:so}))}}if(obj.aggs||obj.aggregations){var aggs=obj.aggs?obj.aggs:obj.aggregations;var anames=Object.keys(aggs);for(var i=0;i<anames.length;i++){var name=anames[i];var agg=aggs[name];var type=Object.keys(agg)[0];var raw={};raw[name]=agg;var oa=es.aggregationFactory(type,{raw:raw});if(oa){this.addAggregation(oa)}}}};if(params.queryString){this.setQueryString(params.queryString)}if(params.sort){this.setSortBy(params.sort)}if(params.raw){this.parse(params.raw)}},newQueryString:function(params){if(!params){params={}}return new es.QueryString(params)},QueryString:function(params){this.queryString=params.queryString||false;this.defaultField=params.defaultField||false;this.defaultOperator=params.defaultOperator||"OR";this.fuzzify=params.fuzzify||false;this.escapeSet=params.escapeSet||es.specialCharsSubSet;this.pairs=params.pairs||es.characterPairs;this.unEscapeSet=params.unEscapeSet||es.specialChars;this.objectify=function(){var qs=this._escape(this._fuzzify(this.queryString));var obj={query_string:{query:qs}};if(this.defaultOperator){obj.query_string["default_operator"]=this.defaultOperator}if(this.defaultField){obj.query_string["default_field"]=this.defaultField}return obj};this.parse=function(obj){if(obj.query_string){obj=obj.query_string}this.queryString=this._unescape(obj.query);if(obj.default_operator){this.defaultOperator=obj.default_operator}if(obj.default_field){this.defaultField=obj.default_field}};this._fuzzify=function(str){if(!this.fuzzify||!(this.fuzzify==="*"||this.fuzzify==="~")){return str}if(!(str.indexOf("*")===-1&&str.indexOf("~")===-1&&str.indexOf(":")===-1)){return str}var pq="";var optparts=str.split(" ");for(var i=0;i<optparts.length;i++){var oip=optparts[i];if(oip.length>0){oip=oip+this.fuzzify;this.fuzzify=="*"?oip="*"+oip:false;pq+=oip+" "}}return pq};this._escapeRegExp=function(string){return string.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")};this._replaceAll=function(string,find,replace){return string.replace(new RegExp(this._escapeRegExp(find),"g"),replace)};this._unReplaceAll=function(string,find){return string.replace(new RegExp("\\\\("+this._escapeRegExp(find)+")","g"),"$1")};this._paired=function(string,pair){var matches=string.match(new RegExp(this._escapeRegExp(pair),"g"))||[];return matches.length%2===0};this._escape=function(str){var scs=this.escapeSet.slice(0);for(var i=0;i<this.pairs.length;i++){var char=this.pairs[i];if(!this._paired(str,char)){scs.push(char)}}for(var i=0;i<scs.length;i++){var char=scs[i];str=this._replaceAll(str,char,"\\"+char)}return str};this._unescape=function(str){for(var i=0;i<this.unEscapeSet.length;i++){var char=this.unEscapeSet[i];str=this._unReplaceAll(str,char)}return str};if(params.raw){this.parse(params.raw)}},newSort:function(params){if(!params){params={}}return new es.Sort(params)},Sort:function(params){this.field=params.field||"_score";this.order=params.order||"desc";this.objectify=function(){var obj={};obj[this.field]={order:this.order};return obj};this.parse=function(obj){this.field=Object.keys(obj)[0];if(obj[this.field].order){this.order=obj[this.field].order}};if(params.raw){this.parse(params.raw)}},newAggregation:function(params){if(!params){params={}}return new es.Aggregation(params)},Aggregation:function(params){this.name=params.name;this.aggs=params.aggs||[];this.addAggregation=function(agg){for(var i=0;i<this.aggs.length;i++){if(this.aggs[i].name===agg.name){return}}this.aggs.push(agg)};this.removeAggregation=function(){};this.clearAggregations=function(){};this._make_aggregation=function(type,body){var obj={};obj[this.name]={};obj[this.name][type]=body;if(this.aggs.length>0){obj[this.name]["aggs"]={};for(var i=0;i<this.aggs.length;i++){$.extend(obj[this.name]["aggs"],this.aggs[i].objectify())}}return obj};this._parse_wrapper=function(obj,type){this.name=Object.keys(obj)[0];var body=obj[this.name][type];var aggs=obj[this.name].aggs?obj[this.name].aggs:obj[this.name].aggregations;if(aggs){var anames=Object.keys(aggs);for(var i=0;i<anames.length;i++){var name=anames[i];var agg=aggs[anames[i]];var subtype=Object.keys(agg)[0];var raw={};raw[name]=agg;var oa=es.aggregationFactory(subtype,{raw:raw});if(oa){this.addAggregation(oa)}}}return body}},newTermsAggregation:function(params){if(!params){params={}}es.TermsAggregation.prototype=es.newAggregation(params);return new es.TermsAggregation(params)},TermsAggregation:function(params){this.field=params.field||false;this.size=params.size||10;this.orderBy="_count";if(params.orderBy){this.orderBy=params.orderBy;if(this.orderBy[0]!=="_"){this.orderBy="_"+this.orderBy}}this.orderDir=params.orderDir||"desc";this.setOrdering=function(orderBy,orderDir){this.orderBy=orderBy;if(this.orderBy[0]!=="_"){this.orderBy="_"+this.orderBy}this.orderDir=orderDir};this.objectify=function(){var body={field:this.field,size:this.size,order:{}};body.order[this.orderBy]=this.orderDir;return this._make_aggregation("terms",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"terms");this.field=body.field;if(body.size){this.size=body.size}if(body.order){this.orderBy=Object.keys(body.order)[0];this.orderDir=body.order[this.orderBy]}};if(params.raw){this.parse(params.raw)}},newCardinalityAggregation:function(params){if(!params){params={}}es.CardinalityAggregation.prototype=es.newAggregation(params);return new es.CardinalityAggregation(params)},CardinalityAggregation:function(params){this.field=es.getParam(params.field,false);this.objectify=function(){var body={field:this.field};return this._make_aggregation("cardinality",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"cardinality");this.field=body.field};if(params.raw){this.parse(params.raw)}},newRangeAggregation:function(params){if(!params){params={}}es.RangeAggregation.prototype=es.newAggregation(params);return new es.RangeAggregation(params)},RangeAggregation:function(params){this.field=params.field||false;this.ranges=params.ranges||[];this.objectify=function(){var body={field:this.field,ranges:this.ranges};return this._make_aggregation("range",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"range");this.field=body.field;this.ranges=body.ranges};if(params.raw){this.parse(params.raw)}},newGeoDistanceAggregation:function(params){if(!params){params={}}es.GeoDistanceAggregation.prototype=es.newAggregation(params);return new es.GeoDistanceAggregation(params)},GeoDistanceAggregation:function(params){this.field=params.field||false;this.lat=params.lat||false;this.lon=params.lon||false;this.unit=params.unit||"m";this.distance_type=params.distance_type||"sloppy_arc";this.ranges=params.ranges||[];this.objectify=function(){var body={field:this.field,origin:{lat:this.lat,lon:this.lon},unit:this.unit,distance_type:this.distance_type,ranges:this.ranges};return this._make_aggregation("geo_distance",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"range");this.field=body.field;var origin=body.origin;if(origin.lat){this.lat=origin.lat}if(origin.lon){this.lon=origin.lon}if(body.unit){this.unit=body.unit}if(body.distance_type){this.distance_type=body.distance_type}this.ranges=body.ranges};if(params.raw){this.parse(params.raw)}},newStatsAggregation:function(params){if(!params){params={}}es.StatsAggregation.prototype=es.newAggregation(params);return new es.StatsAggregation(params)},StatsAggregation:function(params){this.field=params.field||false;this.objectify=function(){var body={field:this.field};return this._make_aggregation("stats",body)};this.parse=function(obj){};if(params.raw){this.parse(params.raw)}},newDateHistogramAggregation:function(params){if(!params){params={}}es.DateHistogramAggregation.prototype=es.newAggregation(params);return new es.DateHistogramAggregation(params)},DateHistogramAggregation:function(params){this.field=params.field||false;this.interval=params.interval||"month";this.format=params.format||false;this.objectify=function(){var body={field:this.field,interval:this.interval};if(this.format){body["format"]=this.format}return this._make_aggregation("date_histogram",body)};this.parse=function(obj){var body=this._parse_wrapper(obj,"date_histogram");this.field=body.field;if(body.interval){this.interval=body.interval}if(body.format){this.format=body.format}};if(params.raw){this.parse(params.raw)}},newFilter:function(params){if(!params){params={}}return new es.Filter(params)},Filter:function(params){this.field=params.field;this.type_name=params.type_name;this.matches=function(other){if(other.type_name!==this.type_name){return false}if(other.field&&other.field!==this.field){return false}return true};this.objectify=function(){};this.parse=function(){}},newTermFilter:function(params){if(!params){params={}}params.type_name="term";es.TermFilter.prototype=es.newFilter(params);return new es.TermFilter(params)},TermFilter:function(params){this.value=params.value||false;this.matches=function(other){var pm=Object.getPrototypeOf(this).matches.call(this,other);if(!pm){return false}if(other.value&&other.value!==this.value){return false}return true};this.objectify=function(){var obj={term:{}};obj.term[this.field]=this.value;return obj};this.parse=function(obj){if(obj.term){obj=obj.term}this.field=Object.keys(obj)[0];this.value=obj[this.field]};if(params.raw){this.parse(params.raw)}},newTermsFilter:function(params){if(!params){params={}}params.type_name="terms";es.TermsFilter.prototype=es.newFilter(params);return new es.TermsFilter(params)},TermsFilter:function(params){this.values=params.values||false;this.execution=params.execution||false;this.matches=function(other){var pm=Object.getPrototypeOf(this).matches.call(this,other);if(!pm){return false}if(other.values){if(other.values.length!==this.values.length){return false}for(var i=0;i<other.values.length;i++){if($.inArray(other.values[i],this.values)===-1){return false}}}return true};this.objectify=function(){var val=this.values||[];var obj={terms:{}};obj.terms[this.field]=val;if(this.execution){obj.terms["execution"]=this.execution}return obj};this.parse=function(obj){if(obj.terms){obj=obj.terms}this.field=Object.keys(obj)[0];this.values=obj[this.field];if(obj.execution){this.execution=obj.execution}};this.add_term=function(term){if(!this.values){this.values=[]}if($.inArray(term,this.values)===-1){this.values.push(term)}};this.has_term=function(term){if(!this.values){return false}return $.inArray(term,this.values)>=0};this.remove_term=function(term){if(!this.values){return}var idx=$.inArray(term,this.values);if(idx>=0){this.values.splice(idx,1)}};this.has_terms=function(){return this.values!==false&&this.values.length>0};this.term_count=function(){return this.values===false?0:this.values.length};this.clear_terms=function(){this.values=false};if(params.raw){this.parse(params.raw)}},newRangeFilter:function(params){if(!params){params={}}params.type_name="range";es.RangeFilter.prototype=es.newFilter(params);return new es.RangeFilter(params)},RangeFilter:function(params){this.lt=es.getParam(params.lt,false);this.lte=es.getParam(params.lte,false);this.gte=es.getParam(params.gte,false);this.matches=function(other){var pm=Object.getPrototypeOf(this).matches.call(this,other);if(!pm){return false}if(other.lt){if(other.lt!==this.lt){return false}}if(other.lte){if(other.lte!==this.lte){return false}}if(other.gte){if(other.gte!==this.gte){return false}}return true};this.objectify=function(){var obj={range:{}};obj.range[this.field]={};if(this.lte){obj.range[this.field]["lte"]=this.lte}if(this.lt&&!this.lte){obj.range[this.field]["lt"]=this.lt}if(this.gte){obj.range[this.field]["gte"]=this.gte}return obj};this.parse=function(obj){if(obj.range){obj=obj.range}this.field=Object.keys(obj)[0];if(obj[this.field].lte){this.lte=obj[this.field].lte}if(obj[this.field].lt){this.lt=obj[this.field].lt}if(obj[this.field].gte){this.gte=obj[this.field].gte}};if(params.raw){this.parse(params.raw)}},newGeoDistanceRangeFilter:function(params){if(!params){params={}}params.type_name="geo_distance_range";es.GeoDistanceRangeFilter.prototype=es.newFilter(params);return new es.GeoDistanceRangeFilter(params)},GeoDistanceRangeFilter:function(params){this.lt=params.lt||false;this.gte=params.gte||false;this.lat=params.lat||false;this.lon=params.lon||false;this.unit=params.unit||"m";this.objectify=function(){var obj={geo_distance_range:{}};obj.geo_distance_range[this.field]={lat:this.lat,lon:this.lon};if(this.lt){obj.geo_distance_range["lt"]=this.lt+this.unit}if(this.gte){obj.geo_distance_range["gte"]=this.gte+this.unit}return obj};this.parse=function(obj){function endsWith(str,suffix){return str.indexOf(suffix,str.length-suffix.length)!==-1}function splitUnits(str){var unit=false;for(var i=0;i<es.distanceUnits.length;i++){var cu=es.distanceUnits[i];if(endsWith(str,cu)){str=str.substring(0,str.length-cu.length);unit=str.substring(str.length-cu.length)}}return[str,unit]}if(obj.geo_distance_range){obj=obj.geo_distance_range}this.field=Object.keys(obj)[0];this.lat=obj[this.field].lat;this.lon=obj[this.field].lon;var lt=obj[this.field].lt;var gte=obj[this.field].gte;if(lt){lt=lt.trim();var parts=splitUnits(lt);this.lt=parts[0];this.unit=parts[1]}if(gte){gte=gte.trim();var parts=splitUnits(gte);this.gte=parts[0];this.unit=parts[1]}};if(params.raw){this.parse(params.raw)}},newResult:function(params){if(!params){params={}}return new es.Result(params)},Result:function(params){this.data=params.raw;this.buckets=function(agg_name){return this.data.aggregations[agg_name].buckets};this.aggregation=function(agg_name){return this.data.aggregations[agg_name]};this.results=function(){var res=[];if(this.data.hits&&this.data.hits.hits){for(var i=0;i<this.data.hits.hits.length;i++){var source=this.data.hits.hits[i];if("_source"in source){res.push(source._source)}else if("fields"in source){res.push(source.fields)}}}return res};this.total=function(){if(this.data.hits&&this.data.hits.total){return parseInt(this.data.hits.total)}return false}},doQuery:function(params){var success=params.success;var complete=params.complete;var search_url=params.search_url;var queryobj=params.queryobj;var datatype=params.datatype;var querystring=JSON.stringify(queryobj);$.ajax({type:"get",url:search_url,data:{source:querystring},dataType:datatype,success:es.querySuccess(success),complete:complete})},querySuccess:function(callback){return function(data){var result=es.newResult({raw:data});callback(result)}},getParam:function(value,def){return value!==undefined?value:def}};
(function($){$.fn.bindWithDelay=function(type,data,fn,timeout,throttle){var wait=null;var that=this;if($.isFunction(data)){throttle=timeout;timeout=fn;fn=data;data=undefined}function cb(){var e=$.extend(true,{},arguments[0]);var throttler=function(){wait=null;fn.apply(that,[e])};if(!throttle){clearTimeout(wait)}if(!throttle||!wait){wait=setTimeout(throttler,timeout)}}return this.bind(type,data,cb)}})(jQuery);
var edges={newEdge:function(params){if(!params){params={}}return new edges.Edge(params)},Edge:function(params){this.selector=params.selector||"body";this.search_url=edges.getParam(params.search_url,false);this.datatype=params.datatype||"jsonp";this.preflightQueries=edges.getParam(params.preflightQueries,false);this.baseQuery=params.baseQuery||false;this.openingQuery=params.openingQuery||es.newQuery();this.secondaryQueries=edges.getParam(params.secondaryQueries,false);this.initialSearch=edges.getParam(params.initialSearch,true);this.staticFiles=edges.getParam(params.staticFiles,[]);this.manageUrl=params.manageUrl||false;this.urlQuerySource=params.urlQuerySource||"source";this.template=params.template||false;this.components=params.components||[];this.renderPacks=params.renderPacks||[edges.bs3,edges.nvd3,edges.highcharts,edges.google,edges.d3];this.urlQuery=false;this.urlParams={};this.shortUrl=false;this.currentQuery=false;this.result=false;this.preflightResults={};this.realisedSecondaryQueries={};this.secondaryResults={};this.searching=false;this.context=false;this.static={};this.resources={};this.errorLoadingStatic=[];this.startup=function(){this.context=$(this.selector);this.context.trigger("edges:pre-init");if(this.manageUrl){var urlParams=this.getUrlParams();if(this.urlQuerySource in urlParams){this.urlQuery=es.newQuery({raw:urlParams[this.urlQuerySource]});delete urlParams[this.urlQuerySource]}this.urlParams=urlParams}if(this.template){this.template.draw(this)}for(var i=0;i<this.components.length;i++){var component=this.components[i];component.init(this)}this.draw();var onward=edges.objClosure(this,"startupPart2");this.loadStaticsAsync(onward)};this.startupPart2=function(){var onward=edges.objClosure(this,"startupPart3");this.runPreflightQueries(onward)};this.startupPart3=function(){var requestedQuery=this.openingQuery;if(this.urlQuery){requestedQuery=this.urlQuery;this.urlQuery=false}for(var i=0;i<this.components.length;i++){var component=this.components[i];component.contrib(requestedQuery)}this.pushQuery(requestedQuery);this.context.trigger("edges:post-init");this.cycle()};this.doQuery=function(){this.cycle()};this.cycle=function(){if(this.searching){return}this.searching=true;this.shortUrl=false;this.context.trigger("edges:pre-query");if(this.manageUrl){this.updateUrl()}if(this.search_url){var onward=edges.objClosure(this,"cyclePart2");this.doPrimaryQuery(onward)}else{this.cyclePart2()}};this.cyclePart2=function(){var onward=edges.objClosure(this,"cyclePart3");this.runSecondaryQueries(onward)};this.cyclePart3=function(){this.synchronise();this.context.trigger("edges:pre-render");this.draw();this.context.trigger("edges:post-render");this.searching=false};this.synchronise=function(){for(var i=0;i<this.components.length;i++){var component=this.components[i];component.synchronise()}};this.draw=function(){for(var i=0;i<this.components.length;i++){var component=this.components[i];component.draw(this)}};this.reset=function(){this.context.trigger("edges:pre-reset");var requestedQuery=this.cloneOpeningQuery();for(var i=0;i<this.components.length;i++){var component=this.components[i];component.contrib(requestedQuery)}this.pushQuery(requestedQuery);this.context.trigger("edges:post-reset");this.cycle()};this.cloneQuery=function(){if(this.currentQuery){return $.extend(true,{},this.currentQuery)}return false};this.pushQuery=function(query){if(this.baseQuery){query.merge(this.baseQuery)}this.currentQuery=query};this.cloneBaseQuery=function(){if(this.baseQuery){return $.extend(true,{},this.baseQuery)}return es.newQuery()};this.cloneOpeningQuery=function(){if(this.openingQuery){return $.extend(true,{},this.openingQuery)}return es.newQuery()};this.doPrimaryQuery=function(callback){var context={callback:callback};es.doQuery({search_url:this.search_url,queryobj:this.currentQuery.objectify(),datatype:this.datatype,success:edges.objClosure(this,"querySuccess",["result"],context),error:edges.objClosure(this,"queryFail",context)})};this.queryFail=function(params){var callback=params.context;this.context.trigger("edges:query-fail");callback()};this.querySuccess=function(params){this.result=params.result;var callback=params.callback;this.context.trigger("edges:query-success");callback()};this.runPreflightQueries=function(callback){if(!this.preflightQueries||Object.keys(this.preflightQueries).length==0){callback();return}this.context.trigger("edges:pre-preflight");var entries=[];var ids=Object.keys(this.preflightQueries);for(var i=0;i<ids.length;i++){var id=ids[i];entries.push({id:id,query:this.preflightQueries[id]})}var that=this;var pg=edges.newAsyncGroup({list:entries,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;es.doQuery({search_url:that.search_url,queryobj:entry.query.objectify(),datatype:that.datatype,success:success,error:error})},successCallbackArgs:["result"],success:function(params){var result=params.result;var entry=params.entry;that.preflightResults[entry.id]=result},errorCallbackArgs:["result"],error:function(params){that.context.trigger("edges:error-preflight")},carryOn:function(){that.context.trigger("edges:post-preflight");callback()}});pg.process()};this.runSecondaryQueries=function(callback){this.realisedSecondaryQueries={};if(!this.secondaryQueries||Object.keys(this.secondaryQueries).length==0){callback();return}var entries=[];for(var key in this.secondaryQueries){var entry={};entry["query"]=this.secondaryQueries[key](this);entry["id"]=key;entries.push(entry);this.realisedSecondaryQueries[key]=entry.query}var that=this;var pg=edges.newAsyncGroup({list:entries,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;es.doQuery({search_url:that.search_url,queryobj:entry.query.objectify(),datatype:that.datatype,success:success,complete:false})},successCallbackArgs:["result"],success:function(params){var result=params.result;var entry=params.entry;that.secondaryResults[entry.id]=result},errorCallbackArgs:["result"],error:function(params){},carryOn:function(){callback()}});pg.process()};this.category=function(cat){var comps=[];for(var i=0;i<this.components.length;i++){var component=this.components[i];if(component.category===cat){comps.push(component)}}return comps};this.getRenderPackObject=function(oname,params){for(var i=0;i<this.renderPacks.length;i++){var rp=this.renderPacks[i];if(rp&&rp.hasOwnProperty(oname)){return rp[oname](params)}}};this.jq=function(selector){return $(selector,this.context)};this.getUrlParams=function(){var params={};var url=window.location.href;var fragment=false;if(url.indexOf("#")>-1){fragment=url.slice(url.indexOf("#"));url=url.substring(0,url.indexOf("#"))}var args=url.slice(url.indexOf("?")+1).split("&");for(var i=0;i<args.length;i++){var kv=args[i].split("=");if(kv.length===2){var val=decodeURIComponent(kv[1]);if(val[0]=="["||val[0]=="{"){val=val.replace(/^"/,"").replace(/"$/,"");val=JSON.parse(val)}params[kv[0]]=val}}if(fragment){params["#"]=fragment}return params};this.urlQueryArg=function(objectify_options){if(!objectify_options){objectify_options={include_query_string:true,include_filters:true,include_paging:true,include_sort:true,include_fields:false,include_aggregations:false,include_facets:false}}var q=JSON.stringify(this.currentQuery.objectify(objectify_options));var obj={};obj[this.urlQuerySource]=encodeURIComponent(q);return obj};this.fullQueryArgs=function(){var args=$.extend(true,{},this.urlParams);$.extend(args,this.urlQueryArg());return args};this.fullUrlQueryString=function(){return this._makeUrlQuery(this.fullQueryArgs())};this._makeUrlQuery=function(args){var keys=Object.keys(args);var entries=[];for(var i=0;i<keys.length;i++){var key=keys[i];var val=args[key];entries.push(key+"="+val)}return entries.join("&")};this.fullUrl=function(){var args=this.fullQueryArgs();var fragment="";if(args["#"]){fragment="#"+args["#"];delete args["#"]}var wloc=window.location.toString();var bits=wloc.split("?");var url=bits[0]+"?"+this._makeUrlQuery(args)+fragment;return url};this.updateUrl=function(){if("pushState"in window.history){var qs="?"+this.fullUrlQueryString();window.history.pushState("","",qs)}};this.loadStaticsAsync=function(callback){if(!this.staticFiles||this.staticFiles.length==0){this.context.trigger("edges:post-load-static");callback();return}var that=this;var pg=edges.newAsyncGroup({list:this.staticFiles,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;var id=entry.id;var url=entry.url;var datatype=edges.getParam(entry.datatype,"text");$.ajax({type:"get",url:url,dataType:datatype,success:success,error:error})},successCallbackArgs:["data"],success:function(params){var data=params.data;var entry=params.entry;if(entry.processor){var processed=entry.processor({data:data});that.resources[entry.id]=processed;if(entry.opening){entry.opening({resource:processed})}}that.static[entry.id]=data},errorCallbackArgs:["data"],error:function(params){that.errorLoadingStatic.push(params.entry.id);that.context.trigger("edges:error-load-static")},carryOn:function(){that.context.trigger("edges:post-load-static");callback()}});pg.process()};this.startup()},newAsyncGroup:function(params){if(!params){params={}}return new edges.AsyncGroup(params)},AsyncGroup:function(params){this.list=params.list;this.successCallbackArgs=params.successCallbackArgs;this.errorCallbackArgs=params.errorCallbackArgs;var action=params.action;var success=params.success;var carryOn=params.carryOn;var error=params.error;this.functions={action:action,success:success,carryOn:carryOn,error:error};this.checkList=[];this.finished=false;this.construct=function(params){for(var i=0;i<this.list.length;i++){this.checkList.push(0)}};this.process=function(params){if(this.list.length==0){this.functions.carryOn()}for(var i=0;i<this.list.length;i++){var context={index:i};var success_callback=edges.objClosure(this,"_actionSuccess",this.successCallbackArgs,context);var error_callback=edges.objClosure(this,"_actionError",this.successCallbackArgs,context);var complete_callback=false;this.functions.action({entry:this.list[i],success_callback:success_callback,error_callback:error_callback,complete_callback:complete_callback})}};this._actionSuccess=function(params){var index=params.index;delete params.index;params["entry"]=this.list[index];this.functions.success(params);this.checkList[index]=1;if(this._isComplete()){this._finalise()}};this._actionError=function(params){var index=params.index;delete params.index;params["entry"]=this.list[index];this.functions.error(params);this.checkList[index]=-1;if(this._isComplete()){this._finalise()}};this._actionComplete=function(params){};this._isComplete=function(){return $.inArray(0,this.checkList)===-1};this._finalise=function(){if(this.finished){return}this.finished=true;this.functions.carryOn()};this.construct()},newRenderer:function(params){if(!params){params={}}return new edges.Renderer(params)},Renderer:function(params){this.component=params.component||false;this.init=function(component){this.component=component};this.draw=function(component){}},newComponent:function(params){if(!params){params={}}return new edges.Component(params)},Component:function(params){this.id=params.id;this.renderer=params.renderer;this.category=params.category||"none";this.defaultRenderer=params.defaultRenderer||"newRenderer";this.init=function(edge){this.edge=edge;this.context=this.edge.jq("#"+this.id);if(!this.renderer){this.renderer=this.edge.getRenderPackObject(this.defaultRenderer)}if(this.renderer){this.renderer.init(this)}};this.draw=function(){if(this.renderer){this.renderer.draw()}};this.contrib=function(query){};this.synchronise=function(){};this.jq=function(selector){return this.edge.jq(selector)}},newSelector:function(params){if(!params){params={}}edges.Selector.prototype=edges.newComponent(params);return new edges.Selector(params)},Selector:function(params){this.field=params.field;this.display=params.display||this.field;this.active=params.active||true;this.disabled=params.disabled||false;this.category=params.category||"selector"},newTemplate:function(params){if(!params){params={}}return new edges.Template(params)},Template:function(params){this.draw=function(edge){}},objClosure:function(obj,fn,args,context_params){return function(){if(args){var params={};for(var i=0;i<args.length;i++){if(arguments.length>i){params[args[i]]=arguments[i]}}if(context_params){params=$.extend(params,context_params)}obj[fn](params)}else{var slice=Array.prototype.slice;var theArgs=slice.apply(arguments);if(context_params){theArgs.push(context_params)}obj[fn].apply(obj,theArgs)}}},eventClosure:function(obj,fn,conditional){return function(event){if(conditional){if(!conditional(event)){return}}event.preventDefault();obj[fn](this)}},css_classes:function(namespace,field,renderer){var cl=namespace+"-"+field;if(renderer){cl+=" "+cl+"-"+renderer.component.id}return cl},css_class_selector:function(namespace,field,renderer){var sel="."+namespace+"-"+field;if(renderer){sel+=sel+"-"+renderer.component.id}return sel},css_id:function(namespace,field,renderer){var id=namespace+"-"+field;if(renderer){id+="-"+renderer.component.id}return id},css_id_selector:function(namespace,field,renderer){return"#"+edges.css_id(namespace,field,renderer)},on:function(selector,event,caller,targetFunction,delay,conditional){if(caller.component&&caller.component.id){event=event+"."+caller.component.id}else if(caller.namespace){event=event+"."+caller.namespace}var clos=edges.eventClosure(caller,targetFunction,conditional);if(delay){if(caller.component){caller.component.jq(selector).bindWithDelay(event,clos,delay)}else if(caller.edge){caller.edge.jq(selector).bindWithDelay(event,clos,delay)}else{console.log("attempt to bindWithDelay on caller which has neither inner component or edge")}}else{if(caller.component){caller.component.jq(selector).on(event,clos)}else if(caller.edge){caller.edge.jq(selector).on(event,clos)}else{console.log("attempt to bindWithDelay on caller which has neither inner component or edge")}}},escapeHtml:function(unsafe,def){if(def===undefined){def=""}if(unsafe===undefined||unsafe==null){return def}try{if(typeof unsafe.replace!=="function"){return unsafe}return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}catch(err){return def}},objVal:function(path,rec,def){if(def===undefined){def=false}var bits=path.split(".");var val=rec;for(var i=0;i<bits.length;i++){var field=bits[i];if(field in val){val=val[field]}else{return def}}return val},getParam:function(value,def){return value!==undefined?value:def},safeId:function(unsafe){return unsafe.replace(/&/g,"_").replace(/</g,"_").replace(/>/g,"_").replace(/"/g,"_").replace(/'/g,"_").replace(/\./gi,"_").replace(/\:/gi,"_").replace(/\s/gi,"_")},numFormat:function(params){var prefix=edges.getParam(params.prefix,"");var zeroPadding=edges.getParam(params.zeroPadding,false);var decimalPlaces=edges.getParam(params.decimalPlaces,false);var thousandsSeparator=edges.getParam(params.thousandsSeparator,false);var decimalSeparator=edges.getParam(params.decimalSeparator,".");var suffix=edges.getParam(params.suffix,"");return function(num){num=parseFloat(num);if(decimalPlaces!==false){num=num.toFixed(decimalPlaces)}else{num=num.toString()}var bits=num.split(".");if(zeroPadding!==false){var zeros=zeroPadding-bits[0].length;var pad="";for(var i=0;i<zeros;i++){pad+="0"}bits[0]=pad+bits[0]}if(thousandsSeparator!==false){bits[0]=bits[0].replace(/\B(?=(\d{3})+(?!\d))/g,thousandsSeparator)}if(bits.length==1){return prefix+bits[0]+suffix}else{return prefix+bits[0]+decimalSeparator+bits[1]+suffix}}}};
$.extend(edges,{csv:{serialise:function(params){var json=params.data;return Papa.unparse(json,{newline:"\n"})},newObjectByRow:function(params){if(!params){params={}}return new edges.csv.ObjectByRow(params)},ObjectByRow:function(params){this.sheet=false;this.filters=[];this.parse=function(params){var data=params.data.replace(/\r\n/g,"\n");this.sheet=Papa.parse(data,{header:true,newline:"\n",skipEmptyLines:true})};this.add_filter=function(params){var filter=params.filter;this.filters.push(filter)};this.clear_filter=function(params){var filter=params.filter;var remove=false;for(var i=0;i<this.filters.length;i++){var filt=this.filters[i];var field_match=filter.field===filt.field;var type_match=filter.type===filt.type||filter.type===undefined;var val_match=filter.value===undefined||filter.value.toString()===filt.value.toString();if(field_match&&type_match&&val_match){remove=i;break}}if(remove!==false){this.filters.splice(remove,1)}};this.iterator=function(params){if(!params){params={}}var filtered=edges.getParam(params.filtered,true);var count=0;var that=this;return{next:function(){if(that.sheet.data.length<=count){return false}for(var i=count;i<that.sheet.data.length;i++){var ret=that.sheet.data[i];var match=false;if(!filtered){match=true}else{match=that._filterMatch({record:ret})}if(match){count=i+1;return ret}}return false}}};this.aggregation=function(params){var agg=params.agg;var type=Object.keys(agg)[0];var field=agg[type];var filtered=edges.getParam(params.filtered,true);if(type==="terms"){return this._termsAggregation({field:field,filtered:filtered})}return[]};this._termsAggregation=function(params){var field=params.field;var filtered=edges.getParam(params.filtered,true);var agg=[];var aggMap={};var iter=this.iterator({filtered:filtered});var res=iter.next();while(res){if(res.hasOwnProperty(field)){var val=res[field];if(val in aggMap){agg[aggMap[val]].count++}else{var i=agg.length;agg.push({term:val,count:1});aggMap[val]=i}}res=iter.next()}return agg};this._filterMatch=function(params){var record=params.record;for(var i=0;i<this.filters.length;i++){var filter=this.filters[i];if(filter.type==="exact"){if(!this._exactFilterMatch({filter:filter,record:record})){return false}}else{return false}}return true};this._exactFilterMatch=function(params){var filter=params.filter;var record=params.record;var field=filter.field;var val=filter.value;if(record[field]!==val){return false}return true};this.parse(params)}}});
$.extend(edges,{newMapView:function(params){if(!params){params={}}edges.MapView.prototype=edges.newComponent(params);return new edges.MapView(params)},MapView:function(params){this.geoPoint=params.geoPoint||"location";this.structure=params.structure||"properties";this.calculateCentre=params.calculateCentre||edges.MapCentreFunctions.pickFirst;this.defaultRenderer=params.defaultRenderer||"newMapViewRenderer";this.locations=[];this.centre={lat:17,lon:0};this.synchronise=function(){this.locations=[];this.centre={lat:17,lon:0};if(this.edge.result){var results=this.edge.result.results();for(var i=0;i<results.length;i++){var res=results[i];var gp=this._getGeoPoint(res);if(gp){var ll=this._getLatLon(gp);ll["obj"]=res;this.locations.push(ll)}}}if(this.locations.length>0){this.centre=this.calculateCentre(this.locations)}};this._getLatLon=function(gp){var ll={};if(this.structure==="properties"){ll["lat"]=parseFloat(gp.lat);ll["lon"]=parseFloat(gp.lon)}return ll};this._getGeoPoint=function(obj){var parts=this.geoPoint.split(".");var context=obj;for(var i=0;i<parts.length;i++){var p=parts[i];var d=i<parts.length-1?{}:false;context=context[p]!==undefined?context[p]:d}return context}},MapCentreFunctions:{pickFirst:function(locations){return{lat:locations[0].lat,lon:locations[0].lon}}},newRegionDataMap:function(params){if(!params){params={}}edges.RegionDataMap.prototype=edges.newComponent(params);return new edges.RegionDataMap(params)},RegionDataMap:function(params){this.functions={sync:edges.getParam(params.synchronise,false)};this.regionData=edges.getParam(params.regionData,{});this.defaultRegionData=edges.getParam(params.defaultRegionData,false);this.defaultRenderer=edges.getParam(params.defaultRenderer,"newRegionDataMapRenderer");this.center=edges.getParam(params.center,false);this.superRegions=edges.getParam(params.superRegions,{});this.synchronise=function(){if(this.functions.sync){this.functions.sync(this)}};this.getSuperRegion=function(params){var region=params.region;for(var srn in this.superRegions){if($.inArray(region,this.superRegions[srn])!==-1){return srn}}return false}}});
$.extend(edges,{newStaticDataGrid:function(params){if(!params){params={}}edges.StaticDataGrid.prototype=edges.newComponent(params);return new edges.StaticDataGrid(params)},StaticDataGrid:function(params){this.resourceId=edges.getParam(params.resourceId,false);this.results=[];this.synchronise=function(){this.results=[];var resource=this.edge.resources[this.resourceId];var iter=resource.iterator();var res=iter.next();while(res){this.results.push(res);res=iter.next()}}},newStaticDataSelector:function(params){if(!params){params={}}edges.StaticDataSelector.prototype=edges.newComponent(params);return new edges.StaticDataSelector(params)},StaticDataSelector:function(params){this.resourceId=edges.getParam(params.resourceId,false);this.filterResourceIds=edges.getParam(params.filterResourceIds,[this.resourceId]);this.field=edges.getParam(params.field,false);this.display=edges.getParam(params.display,"Untitled");this.filters=[];this.selected=[];this.values=[];this.terms=[];this.synchronise=function(){this.filters=[];this.selected=[];this.values=[];this.terms=[];var resource=this.edge.resources[this.resourceId];var terms=resource.aggregation({agg:{terms:this.field},filtered:false});for(var i=0;i<terms.length;i++){var term=terms[i];if(term.term===""){continue}this.values.push({term:term.term,display:term.term,count:term.count});this.terms.push({term:term.term,display:term.term,count:term.count})}for(var i=0;i<resource.filters.length;i++){var filt=resource.filters[i];var field=filt.field;if(field===this.field){var val=filt.value;this.filters.push({term:val,display:val});this.selected.push(val)}}};this.selectTerm=function(term){var filter={field:this.field,type:"exact",value:term};for(var i=0;i<this.filterResourceIds.length;i++){var resourceId=this.filterResourceIds[i];this.edge.resources[resourceId].add_filter({filter:filter})}this.edge.cycle()};this.removeFilter=function(term){var filter=false;if(!term){filter={field:this.field}}else{filter={field:this.field,type:"exact",value:term}}for(var i=0;i<this.filterResourceIds.length;i++){var resourceId=this.filterResourceIds[i];this.edge.resources[resourceId].clear_filter({filter:filter})}this.edge.cycle()};this.selectTerms=function(params){var terms=params.terms;this.removeFilter();this.selectTerm(terms[0]);return true};this.changeSize=function(size){};this.changeSort=function(sortBy,sortDir){}}});
$.extend(true,edges,{bs3:{newNSeparateORTermSelectorRenderer:function(params){if(!params){params={}}edges.bs3.NSeparateORTermSelectorRenderer.prototype=edges.newRenderer(params);return new edges.bs3.NSeparateORTermSelectorRenderer(params)},NSeparateORTermSelectorRenderer:function(params){this.n=edges.getParam(params.n,1);this.properties=edges.getParam(params.properties,[]);this.showCount=edges.getParam(params.showCount,false);this.hideEmpty=edges.getParam(params.hideEmpty,false);this.select2=edges.getParam(params.select2,false);this.namespace="edges-bs3-n-separate-or-term-selector";this.draw=function(){var ts=this.component;var selectClass=edges.css_classes(this.namespace,"select",this);var labelClass=edges.css_classes(this.namespace,"label",this);var containerClass=edges.css_classes(this.namespace,"container",this);var selectorFrag="";for(var j=0;j<this.n;j++){var label=false;var unselected="Select an option";if(this.properties.length>j){var prop=this.properties[j];if(prop.label){label=prop.label}if(prop.unselected){unselected=prop.unselected}}var selectId=edges.css_id(this.namespace,"select-"+j,this);var options="";if(ts.terms.length>0){options+='<option value="">'+edges.escapeHtml(unselected)+"</option>";for(var i=0;i<ts.terms.length;i++){var val=ts.terms[i];if(val.count===0&&this.hideEmpty){continue}options+='<option value="'+edges.escapeHtml(val.term)+'">'+edges.escapeHtml(val.display);if(this.showCount){options+=" ("+val.count+")"}options+="</option>"}}else{options="<option>Loading...</option>"}selectorFrag+='<div class="form-group">                         <label class="'+labelClass+'" for="'+selectId+'">'+edges.escapeHtml(label)+'</label>                        <select id="'+selectId+'" name="'+selectId+'" class="'+selectClass+' form-control">'+options+"</select>                     </div>"}var frag='<div class="'+containerClass+'"><div class="form-inline">'+selectorFrag+"</div></div>";ts.context.html(frag);var selectSelector=edges.css_class_selector(this.namespace,"select",this);if(this.select2){var jq=this.component.jq(selectSelector);jq.select2()}this._setSelectors();edges.on(selectSelector,"change",this,"selectorChanged")};this.selectorChanged=function(element){var vals=[];for(var i=0;i<this.n;i++){var idSelector=edges.css_id_selector(this.namespace,"select-"+i,this);var element=this.component.jq(idSelector);var val=this._getVal({element:element});if(val&&val!=""){vals.push(val)}}var triggered=this.component.selectTerms({terms:vals,clearOthers:true});if(!triggered){this._setSelectors()}};this._setSelectors=function(){var terms=this.component.selected;for(var i=0;i<this.n;i++){var selected=false;var idSelector=edges.css_id_selector(this.namespace,"select-"+i,this);var element=this.component.jq(idSelector);if(terms.length>i){selected=terms[i];this._setVal({element:element,value:selected})}for(var j=0;j<terms.length;j++){if(terms[j]!==selected){element.find("option[value='"+terms[j]+"']").remove()}}}};this._setVal=function(params){var el=params.element;var value=params.value;if(!this.select2){el.val(value)}else{el.select2("val",value)}};this._getVal=function(params){var el=params.element;if(!this.select2){return el.val()}else{return el.select2("val")}}}}});
$.extend(edges,{d3:{regions:{COUNTRIES_BY_CONTINENT:{Africa:["Algeria","Angola","Benin","Botswana","Burkina","Burkina Faso","Burundi","Cameroon","Cape Verde","Central African Republic","Chad","Comoros","Congo","Congo, Democratic Republic of","Republic of the Congo","Democratic Republic of the Congo","Djibouti","Egypt","Equatorial Guinea","Eritrea","Ethiopia","Gabon","Gambia","Ghana","Guinea","Guinea Bissau","Guinea-Bissau","Ivory Coast","Kenya","Lesotho","Liberia","Libya","Madagascar","Malawi","Mali","Mauritania","Mauritius","Morocco","Mozambique","Namibia","Niger","Nigeria","Rwanda","Sao Tome and Principe","Senegal","Seychelles","Sierra Leone","Somalia","South Africa","South Sudan","Sudan","Swaziland","Tanzania","United Republic of Tanzania","Togo","Tunisia","Uganda","Western Sahara","Zambia","Zimbabwe","Somaliland"],Asia:["Afghanistan","Bahrain","Bangladesh","Bhutan","Brunei","Burma (Myanmar)","Cambodia","China","East Timor","India","Indonesia","Iran","Iraq","Israel","Japan","Jordan","Kazakhstan","Korea, North","North Korea","Korea, South","South Korea","Kuwait","Kyrgyzstan","Laos","Lebanon","Myanmar","Malaysia","Maldives","Mongolia","Nepal","Oman","Pakistan","Philippines","Qatar","Russian Federation","Russia","Saudi Arabia","Singapore","Sri Lanka","Syria","Tajikistan","Thailand","Turkey","Turkmenistan","Taiwan","United Arab Emirates","Uzbekistan","Vietnam","Yemen"],Europe:["Albania","Andorra","Armenia","Austria","Azerbaijan","Belarus","Belgium","Bosnia and Herzegovina","Bulgaria","Croatia","Cyprus","Czech Republic","Denmark","Estonia","Falkland Islands","Finland","France","Georgia","Germany","Greece","Hungary","Iceland","Ireland","Italy","Latvia","Liechtenstein","Lithuania","Luxembourg","Macedonia","Malta","Moldova","Monaco","Montenegro","Netherlands","Norway","Poland","Portugal","Romania","San Marino","Serbia","Slovakia","Slovenia","Spain","Sweden","Switzerland","Ukraine","United Kingdom","Vatican City","Republic of Serbia"],"North America":["Antigua and Barbuda","Bahamas","Barbados","Belize","Canada","Costa Rica","Cuba","Dominica","Dominican Republic","El Salvador","Greenland","Grenada","Guatemala","Haiti","Honduras","Jamaica","Mexico","Nicaragua","Panama","Saint Kitts and Nevis","Saint Lucia","Saint Vincent and the Grenadines","Trinidad and Tobago","United States","United States of America"],Oceana:["Antarctica","Australia","Fiji","Kiribati","Marshall Islands","Micronesia","Nauru","New Zealand","Palau","Papua New Guinea","Samoa","Solomon Islands","Tonga","Tuvalu","Vanuatu","French Southern and Antarctic Lands","New Caledonia"],"South America":["Argentina","Bolivia","Brazil","Chile","Colombia","Ecuador","French Guiana","Guyana","Paraguay","Peru","Suriname","Uruguay","Venezuela"]},PADDS:{"PADD 5":["Washington","Oregon","Nevada","California","Arizona","Alaska","Hawaii"],"PADD 4":["Montana","Wyoming","Idaho","Utah","Colorado"],"PADD 3":["New Mexico","Louisiana","Texas","Arkansas","Alabama","Mississippi"],"PADD 2":["North Dakota","South Dakota","Nebraska","Kansas","Minnesota","Oklahoma","Iowa","Missouri","Wisconsin","Michigan","Illinois","Indiana","Ohio","Kentucky","Tennessee"],"PADD 1":["Maine","Vermont","New Hampshire","Massachusetts","Connecticut","Rhode Island","New York","New Jersey","Pennsylvania","Maryland","Delaware","West Virginia","Virginia","North Carolina","South Carolina","Georgia","Florida"]}},featureSetBoundary:function(params){var features=params.features;var path=params.path;var boundExtent=[[null,null],[null,null]];for(var i=0;i<features.length;i++){var thisBounds=path.bounds(features[i]);if(boundExtent[0][0]===null){boundExtent[0][0]=thisBounds[0][0]}if(boundExtent[0][1]===null){boundExtent[0][1]=thisBounds[0][1]}if(boundExtent[1][0]===null){boundExtent[1][0]=thisBounds[1][0]}if(boundExtent[1][1]===null){boundExtent[1][1]=thisBounds[1][1]}boundExtent[0][0]=Math.min(thisBounds[0][0],boundExtent[0][0]);boundExtent[0][1]=Math.min(thisBounds[0][1],boundExtent[0][1]);boundExtent[1][0]=Math.max(thisBounds[1][0],boundExtent[1][0]);boundExtent[1][1]=Math.max(thisBounds[1][1],boundExtent[1][1])}return boundExtent},calculateMapScale:function(params){var features=params.features;var path=params.path;var border=params.border;var scaleFit=params.scaleFit;var width=params.width;var height=params.height;var b=edges.d3.featureSetBoundary({features:features,path:path});var factor=1-border;var s=null;if(scaleFit==="best"){s=factor/Math.max((b[1][0]-b[0][0])/width,(b[1][1]-b[0][1])/height)}else if(scaleFit==="horizontal"){s=factor/((b[1][0]-b[0][0])/width)}else if(scaleFit==="vertical"){s=factor/((b[1][1]-b[0][1])/height)}return s},findPositioningNode:function(params){var child=params.child;var node=$(child).parent();while(true){if(node.length==0){return $("body")[0]}if(node.prop("tagName")==="BODY"){return node[0]}if(node.css("position")!=="static"){return node[0]}node=node.parent()}},mouseXY:function(params){var svg=params.svg;var positioningNode=edges.getParam(params.positioningNode,false);if(!positioningNode){positioningNode=$("body")[0]}var mouse=d3.mouse(positioningNode).map(function(d){return parseInt(d)});return mouse},newGroupedUSStates:function(params){if(!params){params={}}edges.d3.GroupedUSStates.prototype=edges.newRenderer(params);return new edges.d3.GroupedUSStates(params)},GroupedUSStates:function(params){this.namespace="edges-d3-grouped-us-states";this.loaded=false;this.draw=function(){if(this.loaded){return}this.component.context.html("");var domElement=this.component.context.get(0);var tooltip=edges.css_classes(this.namespace,"tooltip",this);var legend=edges.css_classes(this.namespace,"legend",this);var mapClasses=edges.css_classes(this.namespace,"map",this);var width=960;var height=500;var projection=d3.geo.albersUsa().translate([width/2,height/2]).scale([1e3]);var path=d3.geo.path().projection(projection);var color=d3.scale.linear().range(["#6699ff","#99cc00","#9966ff","#ff6666","#ffcc66","#eeeeee"]);var legendText=["PADD1","PADD2","PADD3","PADD4","PADD5","Oops, wrong state name"];var padd1_value=1e4;var padd2_value=2e4;var padd3_value=3e4;var padd4_value=4e4;var padd5_value=5e4;var svg=d3.select(domElement).append("svg").attr("width",width).attr("height",height).attr("class",mapClasses);var div=d3.select(domElement).append("div").attr("class",tooltip).style("opacity",0);color.domain([0,1,2,3,4,5]);d3.json("/static/data/padd/us-states.json",function(json){svg.selectAll("path").data(json.features).enter().append("path").attr("d",path).style("stroke","#fff").style("stroke-width","1").style("fill",function(d){var padd5=["Washington","Oregon","Nevada","California","Arizona","Alaska","Hawaii"];var padd4=["Montana","Wyoming","Idaho","Utah","Colorado"];var padd3=["New Mexico","Louisiana","Texas","Arkansas","Alabama","Mississippi"];var padd2=["North Dakota","South Dakota","Nebraska","Kansas","Minnesota","Oklahoma","Iowa","Missouri","Wisconsin","Michigan","Illinois","Indiana","Ohio","Kentucky","Tennessee"];var padd1=["Maine","Vermont","New Hampshire","Massachusetts","Connecticut","Rhode Island","New York","New Jersey","Pennsylvania","Maryland","Delaware","West Virginia","Virginia","North Carolina","South Carolina","Georgia","Florida"];var name=d.properties.name;if(padd1.indexOf(name)!==-1){return"#6699ff"}else if(padd2.indexOf(name)!==-1){return"#99cc00"}else if(padd3.indexOf(name)!==-1){return"#9966ff"}else if(padd4.indexOf(name)!==-1){return"#ff6666"}else if(padd5.indexOf(name)!==-1){return"#ffcc66"}else{return"#eeeeee"}}).on("mouseover",function(d){var mouse=d3.mouse(svg.node()).map(function(d){return parseInt(d)});div.transition().duration(200).style("opacity",1);div.html("<h4>"+d.properties.name+"</h4>"+"<p>Last month: 25000</p>"+"<p>Prediction: 30000</p>").attr("style","left:"+(mouse[0]+15)+"px; top:"+(mouse[1]-35)+"px").style("color","white")});svg.selectAll("text").data(json.features).enter().append("svg:text").text(function(d){if(d.properties.name==="North Carolina"){return padd1_value}else if(d.properties.name==="Iowa"){return padd2_value}else if(d.properties.name==="Texas"){return padd3_value}else if(d.properties.name==="Wyoming"){return padd4_value}else if(d.properties.name==="Nevada"){return padd5_value}else{return""}}).attr("x",function(d){return path.centroid(d)[0]}).attr("y",function(d){return path.centroid(d)[1]}).attr("text-anchor","middle").attr("font-size","36pt").attr("stroke","white").attr("stroke-width","1px").attr("font-weight","bold").attr("fill","#4d4d4d");var legend=d3.select(domElement).append("svg").attr("class",legend).attr("width",150).attr("height",200).selectAll("g").data(color.domain().slice()).enter().append("g").attr("transform",function(d,i){return"translate(0,"+i*20+")"});legend.append("rect").attr("width",18).attr("height",18).style("fill",color);legend.append("text").data(legendText).attr("x",24).attr("y",9).attr("dy",".35em").text(function(d){return d})});this.loaded=true}},newGenericVectorMap:function(params){if(!params){params={}}edges.d3.GenericVectorMap.prototype=edges.newRenderer(params);return new edges.d3.GenericVectorMap(params)},GenericVectorMap:function(params){this.width=edges.getParam(params.width,960);this.height=edges.getParam(params.height,500);this.projectionType=edges.getParam(params.projectionType,"mercator");this.geojson=edges.getParam(params.geojson,"/static/data/padd/countries.geo.json");this.mapScaleFit=edges.getParam(params.mapScaleFit,"best");this.mapScaleBorder=edges.getParam(params.mapScaleBorder,0);this.matchRegionOn=edges.getParam(params.matchRegionOn,["id","properties.name"]);this.mapCenter=edges.getParam(params.center);this.mapRotate=edges.getParam(params.rotate);this.preDisplayToolTips=edges.getParam(params.preDisplayToolTips,false);this.enableTooltipInteractions=edges.getParam(params.enableTooltipInteractions,true);this.tooltipsBySuperRegion=edges.getParam(params.tooltipsBySuperRegion,false);this.resamplingPrecision=edges.getParam(params.resamplingPrecision,false);this.defaultStroke=edges.getParam(params.defaultStroke,"#ffffff");this.defaultStrokeWidth=edges.getParam(params.defaultStrokeWidth,1);this.defaultFill=edges.getParam(params.defaultFill,"#cccccc");this.regionStyles=edges.getParam(params.regionStyles,{});this.superRegionStyles=edges.getParam(params.superRegionStyles,{});this.toolTipOffsets=edges.getParam(params.toolTipOffsets,false);this.toolTipLeftOffset=edges.getParam(params.toolTipLeftOffset,30);this.toolTipTopOffset=edges.getParam(params.toolTipTopOffset,5);this.functions={renderRegionData:edges.getParam(params.renderRegionData,false)};this.status="fresh";this.redrawRequest=false;this.projectionMap={mercator:d3.geo.mercator,conicConformal:d3.geo.conicConformal,albersUsa:d3.geo.albersUsa};this.svg=false;this.container=false;this.pinned=[];this.json=false;this.positioningNode=false;this.namespace="edges-d3-generic-vector-map";this.draw=function(){if(this.status==="fresh"){this.freshDraw()}else if(this.status==="drawing_initial"){this.redrawRequest=true}else if(this.status==="drawn"){this.updateDraw()}else if(this.status==="drawing_update"){this.redrawRequest=true}};this.freshDraw=function(){this.status="drawing_initial";this.component.context.html("");var domElement=this.component.context.get(0);var containerClass=edges.css_classes(this.namespace,"container",this);var tooltipClass=edges.css_classes(this.namespace,"tooltip",this);var projection=this.projectionMap[this.projectionType]();projection.scale(1);var path=d3.geo.path().projection(projection);this.container=d3.select(domElement).append("div").attr("class",containerClass);this.svg=this.container.append("svg").attr("width",this.width).attr("height",this.height);this.positioningNode=edges.d3.findPositioningNode({child:this.svg.node()});var that=this;d3.json(this.geojson,function(json){that.json=json;var s=edges.d3.calculateMapScale({features:json.features,path:path,width:that.width,height:that.height,scaleFit:that.mapScaleFit,border:that.mapScaleBorder});var c=that.mapCenter;var r=that.mapRotate;if(!c){c={lat:17,lon:0}}if(!r){r={lambda:0,phi:0}}if(projection.center){projection.center([c.lon,c.lat])}if(projection.rotate){projection.rotate([r.lambda,r.phi])}projection.scale(s).translate([that.width/2,that.height/2]);if(that.resamplingPrecision!==false){projection.precision(that.resamplingPrecision)}var show=edges.objClosure(that,"showToolTip",["d"]);var hide=edges.objClosure(that,"hideToolTip",["d"]);var pin=edges.objClosure(that,"togglePinToolTip",["d"]);that.svg.selectAll("path").data(json.features).enter().append("path").attr("d",path).attr("id",function(d){return edges.css_id(that.namespace,"path-"+edges.safeId(d.id),that)}).style("stroke",function(d){return that._getStroke({d:d})}).style("stroke-width",function(d){return that._getStrokeWidth({d:d})}).style("fill",function(d){return that._getFill({d:d})}).on("mouseover",show).on("mouseout",hide).on("click",pin);if(that.preDisplayToolTips!==false){for(var i=0;i<json.features.length;i++){var d=json.features[i];var display=that.preDisplayToolTips===true;if(!display){for(var j=0;j<that.preDisplayToolTips.length;j++){if(that._identifies({id:that.preDisplayToolTips[j],d:d})){display=true;break}}}if(display){var centroid=path.centroid(d);var pos=[false,false];var left_offset=0;var top_offset=0;if(that.toolTipOffsets!==false){var keys=Object.keys(that.toolTipOffsets);for(var j=0;j<keys.length;j++){if(that._identifies({id:keys[j],d:d})){left_offset=that.toolTipOffsets[keys[j]].left;top_offset=that.toolTipOffsets[keys[j]].top;break}}}if(!isNaN(centroid[0])){pos[0]=centroid[0]+left_offset}if(!isNaN(centroid[1])){pos[1]=centroid[1]+top_offset}if(pos[0]!==false&&pos[1]!==false){that.togglePinToolTip({d:d,position:pos,force:true})}}}}});if(this.redrawRequest){this.redrawRequest=false;this.updateDraw()}else{this.status="drawn"}};this.updateDraw=function(){this.status="drawing_update";var invisibleSel=edges.css_class_selector(this.namespace,"invisible",this);var visibleSel=edges.css_class_selector(this.namespace,"visible",this);this.component.jq(invisibleSel).remove();var visibles=this.component.jq(visibleSel);for(var i=0;i<visibles.length;i++){var vis=this.component.jq(visibles[i]);var id=vis.attr("data-id");if(this.tooltipsBySuperRegion){this.reRenderToolTip({id:id})}else{var d=this._getPath({id:id});if(d){this.reRenderToolTip({d:d})}}}if(this.redrawRequest){this.redrawRequest=false;this.updateDraw()}else{this.status="drawn"}};this.togglePinToolTip=function(params){if(this.enableTooltipInteractions===false&&!params.force){return}var d=params.d;var id=d.id;var superRegionId=false;if(this.tooltipsBySuperRegion){superRegionId=this._pathToSuperRegion({d:d});if(superRegionId!==false){id=superRegionId}}var cssIdSelector=edges.css_id_selector(this.namespace,"path-"+edges.safeId(id),this);if(this._isPinned({id:id})){var idx=$.inArray(id,this.pinned);this.pinned.splice(idx,1);this.hideToolTip(params);this.component.jq(cssIdSelector).attr("class","")}else{var pinnedClass=edges.css_classes(this.namespace,"pinned",this);this.component.jq(cssIdSelector).attr("class",pinnedClass);this.showToolTip(params);this.pinned.push(id)}};this.showToolTip=function(params){if(this.enableTooltipInteractions===false&&!params.force){return}var d=params.d;var id=d.id;var superRegionId=false;if(this.tooltipsBySuperRegion){superRegionId=this._pathToSuperRegion({d:d});if(superRegionId){id=superRegionId}}if(this._isPinned({id:id})){return}var position=edges.getParam(params.position,false);if(position===false){position=edges.d3.mouseXY({svg:this.svg,positioningNode:this.positioningNode})}var cssIdSelector=edges.css_id_selector(this.namespace,"tooltip-"+edges.safeId(id),this);var tooltipClass=edges.css_classes(this.namespace,"tooltip",this);var visibleClass=edges.css_classes(this.namespace,"visible",this);var el=this.component.jq(cssIdSelector);if(el.length===0){var cssId=edges.css_id(this.namespace,"tooltip-"+edges.safeId(id),this);var regionData=false;if(this.tooltipsBySuperRegion){regionData=this._getRegionData({id:id})}else{regionData=this._getRegionData({d:d})}var frag=this._renderRegionData({regionData:regionData,d:d,superRegionId:superRegionId});this.container.append("div").attr("id",cssId).attr("class",tooltipClass+" "+visibleClass).attr("data-id",id).html(frag).attr("style",this._positionStyles({ref:position}));el=this.component.jq(cssIdSelector)}else{el.attr("style",this._positionStyles({ref:position})).attr("class",tooltipClass+" "+visibleClass)}};this.reRenderToolTip=function(params){var d=params.d;var id=params.id;if(!id){id=d.id;var superRegionId=false;if(this.tooltipsBySuperRegion){superRegionId=this._pathToSuperRegion({d:d});if(superRegionId){id=superRegionId}}}else{if(this.tooltipsBySuperRegion){superRegionId=id}}var cssIdSelector=edges.css_id_selector(this.namespace,"tooltip-"+edges.safeId(id),this);var regionData=false;if(this.tooltipsBySuperRegion){regionData=this._getRegionData({id:id})}else{regionData=this._getRegionData({d:d})}var frag=this._renderRegionData({regionData:regionData,d:d,superRegionId:superRegionId});var el=this.component.jq(cssIdSelector);el.html(frag)};this.hideToolTip=function(params){if(this.enableTooltipInteractions===false&&!params.force){return}var d=params.d;var id=d.id;var superRegionId=false;if(this.tooltipsBySuperRegion){superRegionId=this._pathToSuperRegion({d:d});if(superRegionId){id=superRegionId}}if(this._isPinned({id:id})){return}var cssIdSelector=edges.css_id_selector(this.namespace,"tooltip-"+edges.safeId(id),this);var tooltipClass=edges.css_classes(this.namespace,"tooltip",this);var inVisibleClasses=edges.css_classes(this.namespace,"invisible",this);var el=this.component.jq(cssIdSelector);if(el.length>0){el.attr("style","display:none").attr("class",tooltipClass+" "+inVisibleClasses)}};this._positionStyles=function(params){var mouse=params.ref;return"left:"+(mouse[0]+this.toolTipLeftOffset)+"px; top:"+(mouse[1]+this.toolTipTopOffset)+"px"};this._isPinned=function(params){return $.inArray(params.id,this.pinned)!==-1};this._getStroke=function(params){return this._getStyle({d:params.d,style:"stroke",def:this.defaultStroke})};this._getStrokeWidth=function(params){return this._getStyle({d:params.d,style:"stroke-width",def:this.defaultStrokeWidth})};this._getFill=function(params){return this._getStyle({d:params.d,style:"fill",def:this.defaultFill})};this._getStyle=function(params){var d=params.d;var style=params.style;var def=params.def;for(var i=0;i<this.matchRegionOn.length;i++){var matchField=this.matchRegionOn[i];var fieldVal=edges.objVal(matchField,d,false);if(!fieldVal){continue}if(fieldVal&&this.regionStyles[fieldVal]){var rs=this.regionStyles[fieldVal];if(rs[style]){return rs[style]}}}for(var i=0;i<this.matchRegionOn.length;i++){var matchField=this.matchRegionOn[i];var fieldVal=edges.objVal(matchField,d,false);if(!fieldVal){continue}var sr=this.component.getSuperRegion({region:fieldVal});if(sr){var srs=this.superRegionStyles[sr];if(srs[style]){return srs[style]}}}return def};this._getRegionData=function(params){var d=params.d;var id=params.id;if(d){for(var i=0;i<this.matchRegionOn.length;i++){var matchField=this.matchRegionOn[i];var fieldVal=edges.objVal(matchField,d,false);if(fieldVal&&this.component.regionData[fieldVal]){return this.component.regionData[fieldVal]}}}else if(id){if(this.component.regionData[id]){return this.component.regionData[id]}}return this.component.defaultRegionData};this._renderRegionData=function(params){if(this.functions.renderRegionData){return this.functions.renderRegionData(params)}var regionData=params.regionData;var d=params.d;var superRegionId=edges.getParam(params.superRegionId,false);var title=d.properties.name;if(superRegionId){title=superRegionId}var frag="<h4>"+title+"</h4>";for(var field in regionData){var val=regionData[field];frag+="<p>"+edges.escapeHtml(field)+": "+edges.escapeHtml(val)+"</p>"}return frag};this._identifies=function(params){var id=params.id;var d=params.d;for(var i=0;i<this.matchRegionOn.length;i++){var matchField=this.matchRegionOn[i];var fieldVal=edges.objVal(matchField,d,false);if(fieldVal&&id===fieldVal){return true}}return false};this._getPath=function(params){var id=params.id;for(var i=0;i<this.json.features.length;i++){var feature=this.json.features[i];if(this._identifies({id:id,d:feature})){return feature}}return false};this._pathToSuperRegion=function(params){var d=params.d;if(!this.component.superRegions){return false}for(var sr in this.component.superRegions){var regions=this.component.superRegions[sr];for(var i=0;i<regions.length;i++){var region=regions[i];if(this._identifies({id:region,d:d})){return sr}}}return false}}}});
var na={activeEdge:false,num:edges.numFormat({thousandsSeparator:","}),COUNTRY_ID_MAP:{US:"USA",Canada:"CAN"},COUNTRY_DISPLAY_MAP:{"United States of America":"US"},preFilterCSVs:function(params){var resource=params.resource;var year=(new Date).getUTCFullYear().toString();resource.add_filter({filter:{field:"From",value:year,type:"exact"}})},conProdSync:function(component){var resources=component.edge.resources;var consumption=resources.consumption;var production=resources.production;component.regionData={};var con_totals={};var prod_totals={};var coniter=consumption.iterator();var res=coniter.next();while(res){var area=res["Area"];if(area!==""){res=coniter.next();continue}var val=res["Value"];if(val===""){res=coniter.next();continue}var int=parseInt(val.replace(/,/g,""));var id=res["Country"];var from=res["From"];var key="Consumption ("+from+")";id=na.COUNTRY_ID_MAP[id];component.regionData[id]={};component.regionData[id][key]=val;con_totals[id]=int;res=coniter.next()}var proditer=production.iterator();var res=proditer.next();while(res){var area=res["Area"];if(area!==""){res=proditer.next();continue}var val=res["Value"];if(val===""){res=proditer.next();continue}var int=parseInt(val.replace(/,/g,""));var id=res["Country"];var type=res["Production source"];type=type.trim();var from=res["From"];var key="Production, "+type+" ("+from+")";id=na.COUNTRY_ID_MAP[id];if(!component.regionData[id]){component.regionData[id]={}}component.regionData[id][key]=val;if(type==="Total"){prod_totals[id]=int}res=proditer.next()}for(var id in con_totals){var ct=con_totals[id];var pt=prod_totals[id];if(pt){var bal=pt-ct;component.regionData[id]["Balance"]=na.num(bal)}}},paddSync:function(component){var resources=component.edge.resources;var consumption=resources.consumption;var production=resources.production;component.regionData={};var con_totals={};var prod_totals={};var coniter=consumption.iterator();var res=coniter.next();while(res){var area=res["Area"];if(area.substring(0,4)!=="PADD"){res=coniter.next();continue}var val=res["Value"];if(val===""){res=coniter.next();continue}var int=parseInt(val.replace(/,/g,""));var from=res["From"];var key="Consumption ("+from+")";component.regionData[area]={};component.regionData[area][key]=val;if(!isNaN(int)){con_totals[area]=int}res=coniter.next()}var proditer=production.iterator();var res=proditer.next();while(res){var area=res["Area"];if(area.substring(0,4)!=="PADD"){res=proditer.next();continue}var val=res["Value"];if(val===""){res=proditer.next();continue}var int=parseInt(val.replace(/,/g,""));var type=res["Production source"];var from=res["From"];var key="Production, "+type+" ("+from+")";if(!component.regionData[area]){component.regionData[area]={}}component.regionData[area][key]=val;if(!isNaN(int)){prod_totals[area]=int}res=proditer.next()}for(var id in con_totals){var ct=con_totals[id];var pt=prod_totals[id];if(pt){var bal=pt-ct;component.regionData[id]["Balance"]=na.num(bal)}}},renderRegionData:function(params){var regionData=params.regionData;var d=params.d;var superRegionId=edges.getParam(params.superRegionId,false);var title="";if(d){title=d.properties.name}if(superRegionId){title=superRegionId}if(na.COUNTRY_DISPLAY_MAP[title]){title=na.COUNTRY_DISPLAY_MAP[title]}var frag="<h4>"+title+"</h4>";frag+="<table class='tooltip-table'><tbody>";for(var field in regionData){var val=regionData[field];frag+="<tr><td class='table-label'>"+edges.escapeHtml(field)+"</td><td class='table-value'>"+edges.escapeHtml(val)+"</td></tr>"}frag+="</tbody></table>";return frag},create:function(params){var prod=params.production;var con=params.consumption;var countries=params.countries;var states=params.states;var padds=edges.d3.regions.PADDS;padds["PADD 4 & 5"]=padds["PADD 4"].concat(padds["PADD 5"]);delete padds["PADD 4"];delete padds["PADD 5"];var e=edges.newEdge({selector:"#acuity",template:na.newTemplate(),staticFiles:[{id:"consumption",url:con,processor:edges.csv.newObjectByRow,datatype:"text",opening:na.preFilterCSVs},{id:"production",url:prod,processor:edges.csv.newObjectByRow,datatype:"text",opening:na.preFilterCSVs}],components:[edges.newStaticDataSelector({id:"year-selector",resourceId:"consumption",filterResourceIds:["consumption","production"],field:"From",display:"Year",renderer:edges.bs3.newNSeparateORTermSelectorRenderer({n:1,properties:[{label:"Year",unselected:"<select a year>"}]})}),edges.newRegionDataMap({id:"na-map",synchronise:na.conProdSync,renderer:edges.d3.newGenericVectorMap({width:1100,height:700,projectionType:"mercator",geojson:countries,center:{lat:55,lon:40},rotate:{lambda:150,phi:0},mapScaleFit:"best",mapScaleBorder:-3,preDisplayToolTips:["CAN","USA"],toolTipOffsets:{USA:{left:-100,top:120},CAN:{left:-50,top:100}},regionStyles:{CAN:{stroke:"#ffffff","stroke-width":1,fill:"#FF0000"},USA:{stroke:"#ffffff","stroke-width":1,fill:"#0000FF"}},enableTooltipInteractions:false,renderRegionData:na.renderRegionData})}),edges.newRegionDataMap({id:"us-map",superRegions:padds,synchronise:na.paddSync,defaultRegionData:{"No Production or Consumption data for this year":""},renderer:edges.d3.newGenericVectorMap({width:1100,height:700,projectionType:"albersUsa",geojson:states,mapScaleFit:"best",mapScaleBorder:0,superRegionStyles:{"PADD 1":{stroke:"#ffffff","stroke-width":1,fill:"#6699ff"},"PADD 2":{stroke:"#ffffff","stroke-width":1,fill:"#99cc00"},"PADD 3":{stroke:"#ffffff","stroke-width":1,fill:"#9966ff"},"PADD 4 & 5":{stroke:"#ffffff","stroke-width":1,fill:"#ff6666"}},tooltipsBySuperRegion:true,renderRegionData:na.renderRegionData})})]});na.activeEdge=e},newTemplate:function(params){if(!params){params={}}na.Template.prototype=edges.newTemplate(params);return new na.Template(params)},Template:function(params){var id=edges.getParam(params.id,"na-map");this.namespace="na-template";this.draw=function(edge){this.edge=edge;var frag='<div class="row"><div class="col-md-offset-5 col-md-2"><div id="year-selector" style="margin-bottom: 20px;"></div></div></div><div class="row">                <div class="col-md-12">                    <div id="'+id+'"></div>                    <div id="us-map"></div>                </div>            </div>';edge.context.html(frag)}}};
