var edges={newEdge:function(params){if(!params){params={}}return new edges.Edge(params)},Edge:function(params){this.selector=params.selector||"body";this.search_url=edges.getParam(params.search_url,false);this.datatype=params.datatype||"jsonp";this.preflightQueries=edges.getParam(params.preflightQueries,false);this.baseQuery=params.baseQuery||false;this.openingQuery=params.openingQuery||es.newQuery();this.secondaryQueries=edges.getParam(params.secondaryQueries,false);this.initialSearch=edges.getParam(params.initialSearch,true);this.staticFiles=edges.getParam(params.staticFiles,[]);this.manageUrl=params.manageUrl||false;this.urlQuerySource=params.urlQuerySource||"source";this.template=params.template||false;this.components=params.components||[];this.renderPacks=params.renderPacks||[edges.bs3,edges.nvd3,edges.highcharts,edges.google,edges.d3];this.urlQuery=false;this.urlParams={};this.shortUrl=false;this.currentQuery=false;this.result=false;this.preflightResults={};this.realisedSecondaryQueries={};this.secondaryResults={};this.searching=false;this.context=false;this.static={};this.resources={};this.errorLoadingStatic=[];this.startup=function(){this.context=$(this.selector);this.context.trigger("edges:pre-init");if(this.manageUrl){var urlParams=this.getUrlParams();if(this.urlQuerySource in urlParams){this.urlQuery=es.newQuery({raw:urlParams[this.urlQuerySource]});delete urlParams[this.urlQuerySource]}this.urlParams=urlParams}if(this.template){this.template.draw(this)}for(var i=0;i<this.components.length;i++){var component=this.components[i];component.init(this)}this.draw();var onward=edges.objClosure(this,"startupPart2");this.loadStaticsAsync(onward)};this.startupPart2=function(){var onward=edges.objClosure(this,"startupPart3");this.runPreflightQueries(onward)};this.startupPart3=function(){var requestedQuery=this.openingQuery;if(this.urlQuery){requestedQuery=this.urlQuery;this.urlQuery=false}for(var i=0;i<this.components.length;i++){var component=this.components[i];component.contrib(requestedQuery)}this.pushQuery(requestedQuery);this.context.trigger("edges:post-init");this.cycle()};this.doQuery=function(){this.cycle()};this.cycle=function(){if(this.searching){return}this.searching=true;this.shortUrl=false;this.context.trigger("edges:pre-query");if(this.manageUrl){this.updateUrl()}if(this.search_url){var onward=edges.objClosure(this,"cyclePart2");this.doPrimaryQuery(onward)}else{this.cyclePart2()}};this.cyclePart2=function(){var onward=edges.objClosure(this,"cyclePart3");this.runSecondaryQueries(onward)};this.cyclePart3=function(){this.synchronise();this.context.trigger("edges:pre-render");this.draw();this.context.trigger("edges:post-render");this.searching=false};this.synchronise=function(){for(var i=0;i<this.components.length;i++){var component=this.components[i];component.synchronise()}};this.draw=function(){for(var i=0;i<this.components.length;i++){var component=this.components[i];component.draw(this)}};this.reset=function(){this.context.trigger("edges:pre-reset");var requestedQuery=this.cloneOpeningQuery();for(var i=0;i<this.components.length;i++){var component=this.components[i];component.contrib(requestedQuery)}this.pushQuery(requestedQuery);this.context.trigger("edges:post-reset");this.cycle()};this.cloneQuery=function(){if(this.currentQuery){return $.extend(true,{},this.currentQuery)}return false};this.pushQuery=function(query){if(this.baseQuery){query.merge(this.baseQuery)}this.currentQuery=query};this.cloneBaseQuery=function(){if(this.baseQuery){return $.extend(true,{},this.baseQuery)}return es.newQuery()};this.cloneOpeningQuery=function(){if(this.openingQuery){return $.extend(true,{},this.openingQuery)}return es.newQuery()};this.doPrimaryQuery=function(callback){var context={callback:callback};es.doQuery({search_url:this.search_url,queryobj:this.currentQuery.objectify(),datatype:this.datatype,success:edges.objClosure(this,"querySuccess",["result"],context),error:edges.objClosure(this,"queryFail",context)})};this.queryFail=function(params){var callback=params.context;this.context.trigger("edges:query-fail");callback()};this.querySuccess=function(params){this.result=params.result;var callback=params.callback;this.context.trigger("edges:query-success");callback()};this.runPreflightQueries=function(callback){if(!this.preflightQueries||Object.keys(this.preflightQueries).length==0){callback();return}this.context.trigger("edges:pre-preflight");var entries=[];var ids=Object.keys(this.preflightQueries);for(var i=0;i<ids.length;i++){var id=ids[i];entries.push({id:id,query:this.preflightQueries[id]})}var that=this;var pg=edges.newAsyncGroup({list:entries,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;es.doQuery({search_url:that.search_url,queryobj:entry.query.objectify(),datatype:that.datatype,success:success,error:error})},successCallbackArgs:["result"],success:function(params){var result=params.result;var entry=params.entry;that.preflightResults[entry.id]=result},errorCallbackArgs:["result"],error:function(params){that.context.trigger("edges:error-preflight")},carryOn:function(){that.context.trigger("edges:post-preflight");callback()}});pg.process()};this.runSecondaryQueries=function(callback){this.realisedSecondaryQueries={};if(!this.secondaryQueries||Object.keys(this.secondaryQueries).length==0){callback();return}var entries=[];for(var key in this.secondaryQueries){var entry={};entry["query"]=this.secondaryQueries[key](this);entry["id"]=key;entries.push(entry);this.realisedSecondaryQueries[key]=entry.query}var that=this;var pg=edges.newAsyncGroup({list:entries,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;es.doQuery({search_url:that.search_url,queryobj:entry.query.objectify(),datatype:that.datatype,success:success,complete:false})},successCallbackArgs:["result"],success:function(params){var result=params.result;var entry=params.entry;that.secondaryResults[entry.id]=result},errorCallbackArgs:["result"],error:function(params){},carryOn:function(){callback()}});pg.process()};this.category=function(cat){var comps=[];for(var i=0;i<this.components.length;i++){var component=this.components[i];if(component.category===cat){comps.push(component)}}return comps};this.getRenderPackObject=function(oname,params){for(var i=0;i<this.renderPacks.length;i++){var rp=this.renderPacks[i];if(rp&&rp.hasOwnProperty(oname)){return rp[oname](params)}}};this.jq=function(selector){return $(selector,this.context)};this.getUrlParams=function(){var params={};var url=window.location.href;var fragment=false;if(url.indexOf("#")>-1){fragment=url.slice(url.indexOf("#"));url=url.substring(0,url.indexOf("#"))}var args=url.slice(url.indexOf("?")+1).split("&");for(var i=0;i<args.length;i++){var kv=args[i].split("=");if(kv.length===2){var val=decodeURIComponent(kv[1]);if(val[0]=="["||val[0]=="{"){val=val.replace(/^"/,"").replace(/"$/,"");val=JSON.parse(val)}params[kv[0]]=val}}if(fragment){params["#"]=fragment}return params};this.urlQueryArg=function(objectify_options){if(!objectify_options){objectify_options={include_query_string:true,include_filters:true,include_paging:true,include_sort:true,include_fields:false,include_aggregations:false,include_facets:false}}var q=JSON.stringify(this.currentQuery.objectify(objectify_options));var obj={};obj[this.urlQuerySource]=encodeURIComponent(q);return obj};this.fullQueryArgs=function(){var args=$.extend(true,{},this.urlParams);$.extend(args,this.urlQueryArg());return args};this.fullUrlQueryString=function(){return this._makeUrlQuery(this.fullQueryArgs())};this._makeUrlQuery=function(args){var keys=Object.keys(args);var entries=[];for(var i=0;i<keys.length;i++){var key=keys[i];var val=args[key];entries.push(key+"="+val)}return entries.join("&")};this.fullUrl=function(){var args=this.fullQueryArgs();var fragment="";if(args["#"]){fragment="#"+args["#"];delete args["#"]}var wloc=window.location.toString();var bits=wloc.split("?");var url=bits[0]+"?"+this._makeUrlQuery(args)+fragment;return url};this.updateUrl=function(){if("pushState"in window.history){var qs="?"+this.fullUrlQueryString();window.history.pushState("","",qs)}};this.loadStaticsAsync=function(callback){if(!this.staticFiles||this.staticFiles.length==0){this.context.trigger("edges:post-load-static");callback();return}var that=this;var pg=edges.newAsyncGroup({list:this.staticFiles,action:function(params){var entry=params.entry;var success=params.success_callback;var error=params.error_callback;var id=entry.id;var url=entry.url;var datatype=edges.getParam(entry.datatype,"text");$.ajax({type:"get",url:url,dataType:datatype,success:success,error:error})},successCallbackArgs:["data"],success:function(params){var data=params.data;var entry=params.entry;if(entry.processor){var processed=entry.processor({data:data});that.resources[entry.id]=processed;if(entry.opening){entry.opening({resource:processed})}}that.static[entry.id]=data},errorCallbackArgs:["data"],error:function(params){that.errorLoadingStatic.push(params.entry.id);that.context.trigger("edges:error-load-static")},carryOn:function(){that.context.trigger("edges:post-load-static");callback()}});pg.process()};this.startup()},newAsyncGroup:function(params){if(!params){params={}}return new edges.AsyncGroup(params)},AsyncGroup:function(params){this.list=params.list;this.successCallbackArgs=params.successCallbackArgs;this.errorCallbackArgs=params.errorCallbackArgs;var action=params.action;var success=params.success;var carryOn=params.carryOn;var error=params.error;this.functions={action:action,success:success,carryOn:carryOn,error:error};this.checkList=[];this.finished=false;this.construct=function(params){for(var i=0;i<this.list.length;i++){this.checkList.push(0)}};this.process=function(params){if(this.list.length==0){this.functions.carryOn()}for(var i=0;i<this.list.length;i++){var context={index:i};var success_callback=edges.objClosure(this,"_actionSuccess",this.successCallbackArgs,context);var error_callback=edges.objClosure(this,"_actionError",this.successCallbackArgs,context);var complete_callback=false;this.functions.action({entry:this.list[i],success_callback:success_callback,error_callback:error_callback,complete_callback:complete_callback})}};this._actionSuccess=function(params){var index=params.index;delete params.index;params["entry"]=this.list[index];this.functions.success(params);this.checkList[index]=1;if(this._isComplete()){this._finalise()}};this._actionError=function(params){var index=params.index;delete params.index;params["entry"]=this.list[index];this.functions.error(params);this.checkList[index]=-1;if(this._isComplete()){this._finalise()}};this._actionComplete=function(params){};this._isComplete=function(){return $.inArray(0,this.checkList)===-1};this._finalise=function(){if(this.finished){return}this.finished=true;this.functions.carryOn()};this.construct()},newRenderer:function(params){if(!params){params={}}return new edges.Renderer(params)},Renderer:function(params){this.component=params.component||false;this.init=function(component){this.component=component};this.draw=function(component){}},newComponent:function(params){if(!params){params={}}return new edges.Component(params)},Component:function(params){this.id=params.id;this.renderer=params.renderer;this.category=params.category||"none";this.defaultRenderer=params.defaultRenderer||"newRenderer";this.init=function(edge){this.edge=edge;this.context=this.edge.jq("#"+this.id);if(!this.renderer){this.renderer=this.edge.getRenderPackObject(this.defaultRenderer)}if(this.renderer){this.renderer.init(this)}};this.draw=function(){if(this.renderer){this.renderer.draw()}};this.contrib=function(query){};this.synchronise=function(){};this.jq=function(selector){return this.edge.jq(selector)}},newSelector:function(params){if(!params){params={}}edges.Selector.prototype=edges.newComponent(params);return new edges.Selector(params)},Selector:function(params){this.field=params.field;this.display=params.display||this.field;this.active=params.active||true;this.disabled=params.disabled||false;this.category=params.category||"selector"},newTemplate:function(params){if(!params){params={}}return new edges.Template(params)},Template:function(params){this.draw=function(edge){}},objClosure:function(obj,fn,args,context_params){return function(){if(args){var params={};for(var i=0;i<args.length;i++){if(arguments.length>i){params[args[i]]=arguments[i]}}if(context_params){params=$.extend(params,context_params)}obj[fn](params)}else{var slice=Array.prototype.slice;var theArgs=slice.apply(arguments);if(context_params){theArgs.push(context_params)}obj[fn].apply(obj,theArgs)}}},eventClosure:function(obj,fn,conditional){return function(event){if(conditional){if(!conditional(event)){return}}event.preventDefault();obj[fn](this)}},css_classes:function(namespace,field,renderer){var cl=namespace+"-"+field;if(renderer){cl+=" "+cl+"-"+renderer.component.id}return cl},css_class_selector:function(namespace,field,renderer){var sel="."+namespace+"-"+field;if(renderer){sel+=sel+"-"+renderer.component.id}return sel},css_id:function(namespace,field,renderer){var id=namespace+"-"+field;if(renderer){id+="-"+renderer.component.id}return id},css_id_selector:function(namespace,field,renderer){return"#"+edges.css_id(namespace,field,renderer)},on:function(selector,event,caller,targetFunction,delay,conditional){if(caller.component&&caller.component.id){event=event+"."+caller.component.id}else if(caller.namespace){event=event+"."+caller.namespace}var clos=edges.eventClosure(caller,targetFunction,conditional);if(delay){if(caller.component){caller.component.jq(selector).bindWithDelay(event,clos,delay)}else if(caller.edge){caller.edge.jq(selector).bindWithDelay(event,clos,delay)}else{console.log("attempt to bindWithDelay on caller which has neither inner component or edge")}}else{if(caller.component){caller.component.jq(selector).on(event,clos)}else if(caller.edge){caller.edge.jq(selector).on(event,clos)}else{console.log("attempt to bindWithDelay on caller which has neither inner component or edge")}}},escapeHtml:function(unsafe,def){if(def===undefined){def=""}if(unsafe===undefined||unsafe==null){return def}try{if(typeof unsafe.replace!=="function"){return unsafe}return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}catch(err){return def}},objVal:function(path,rec,def){if(def===undefined){def=false}var bits=path.split(".");var val=rec;for(var i=0;i<bits.length;i++){var field=bits[i];if(field in val){val=val[field]}else{return def}}return val},getParam:function(value,def){return value!==undefined?value:def},safeId:function(unsafe){return unsafe.replace(/&/g,"_").replace(/</g,"_").replace(/>/g,"_").replace(/"/g,"_").replace(/'/g,"_").replace(/\./gi,"_").replace(/\:/gi,"_").replace(/\s/gi,"_")},numFormat:function(params){var prefix=edges.getParam(params.prefix,"");var zeroPadding=edges.getParam(params.zeroPadding,false);var decimalPlaces=edges.getParam(params.decimalPlaces,false);var thousandsSeparator=edges.getParam(params.thousandsSeparator,false);var decimalSeparator=edges.getParam(params.decimalSeparator,".");var suffix=edges.getParam(params.suffix,"");return function(num){num=parseFloat(num);if(decimalPlaces!==false){num=num.toFixed(decimalPlaces)}else{num=num.toString()}var bits=num.split(".");if(zeroPadding!==false){var zeros=zeroPadding-bits[0].length;var pad="";for(var i=0;i<zeros;i++){pad+="0"}bits[0]=pad+bits[0]}if(thousandsSeparator!==false){bits[0]=bits[0].replace(/\B(?=(\d{3})+(?!\d))/g,thousandsSeparator)}if(bits.length==1){return prefix+bits[0]+suffix}else{return prefix+bits[0]+decimalSeparator+bits[1]+suffix}}}};